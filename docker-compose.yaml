version: "3"
services:
  human-api:
    build: .
    environment:
      - HMT_ETH_SERVER=[Your blockchain URL, or ws://ganache:8545 if you just want to test it out locally]
      - GAS_PAYER=[The first address generated by your mnemonic]
      - GAS_PAYER_PRIV=[The private key of the above address]
      - REP_ORACLE_PUB_KEY=[The public key of the above address]
    links:
      - ganache
      - hmt-escrow
    ports:
      - 8080:8080
    volumes:
      - .:/work
      - hmt-escrow:/deployed-hmtoken

  hmt-escrow:
    image: humanprotocol/hmt-escrow:release-0.9.1
    environment:
      - HMT_ETH_SERVER=[Your blockchain URL, or ws://ganache:8545 if you just want to test it out locally]
      - GAS_LIMIT=6700000
      - ESCROW_BUCKETNAME=escrow-results
      - ESCROW_AWS_ACCESS_KEY_ID=minio
      - ESCROW_AWS_SECRET_ACCESS_KEY=minio123
      - ESCROW_ENDPOINT_URL=http://minio:9000
      - ESCROW_AWS_DEFAULT_REGION=us-west-2
      - DEBUG=true
      - USE_ESCROW_S3_STORAGE=True
      - MNEMONIC=${MNEMONIC}
    depends_on:
      - minio
      - ganache
    links:
      - ganache
    volumes:
      - ./minio:/data
      - hmt-escrow:/deployed-hmtoken
    command: sh -c "rm /deployed-hmtoken/hmt.address.json; curl --retry 10 --retry-connrefused --retry-max-time 10 [Your blockchain URL, or ws://ganache:8545 if you just want to test it out locally]; echo MNEMONIC=${MNEMONIC} > /work/.env; npm install && npx truffle deploy --network [Your blockchain name]"     
  
  ganache:
    image: trufflesuite/ganache-cli:latest
    command: node /app/ganache-core.docker.cli.js --noVMErrorsOnRPCResponse -m goat --hostname 0.0.0.0 --unlock 0x1413862c2b7054cdbfdc181b83962cb0fc11fd92 -g 1000 -f [Your blockchain URL]
    ports:
      - 8545:8545

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
    expose:
      - "9000"
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    entrypoint: sh -c 'minio server /data/'
    volumes:
      - ./minio:/data

volumes:
  hmt-escrow: